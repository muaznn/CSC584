<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RecycleHub - Eco Rewards</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="container header-content">
            <a href="user-dashboard.html" class="logo">
                <span>‚ôªÔ∏è</span>
                <span>RecycleHub</span>
            </a>
            <nav>
                <ul id="nav-menu">
                    <!-- Populated by JavaScript -->
                </ul>
            </nav>
            <div class="user-menu">
                <span id="user-display">Guest</span>
                <span id="user-role" class="user-role">Guest</span>
                <button id="logout-btn" class="btn btn-danger" onclick="logout()">Logout</button>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="page-container active">
            <h1 class="page-title">‚ôªÔ∏è Eco Rewards</h1>
            
            <div class="card">
                <!-- Header Section: The "Bank" -->
                <div style="background: linear-gradient(135deg, #ff9800, #ff5722); color: white; padding: 25px; border-radius: var(--radius); margin-bottom: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                        <div>
                            <h2 style="font-size: 28px; margin-bottom: 5px;">Your Eco Points</h2>
                            <div class="stat-value" id="current-points-balance">0</div>
                            <p style="opacity: 0.9; font-size: 14px;">Available for redemption</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 20px; display: inline-block;">
                                <div style="font-size: 14px; opacity: 0.9;">Current Rank</div>
                                <div style="font-size: 24px; font-weight: 700;" id="user-rank">Bronze</div>
                            </div>
                            <div style="margin-top: 10px; font-size: 14px;">
                                <span id="next-rank-points">0</span> points to next rank
                            </div>
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div style="margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>Bronze</span>
                            <span>Silver</span>
                            <span>Gold</span>
                            <span>Platinum</span>
                        </div>
                        <div style="background: rgba(255,255,255,0.3); height: 10px; border-radius: 5px; overflow: hidden;">
                            <div id="rank-progress" style="background: white; height: 100%; width: 25%; transition: width 0.5s;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Tabs for Marketplace and My Rewards -->
                <div class="tabs">
                    <button class="tab active" onclick="switchRewardTab('marketplace')">Marketplace</button>
                    <button class="tab" onclick="switchRewardTab('my-rewards')">My Rewards</button>
                </div>
                
                <!-- Marketplace Tab -->
                <div class="tab-content active" id="marketplace-tab">
                    <h3 style="margin-bottom: 20px; color: var(--primary-green);">Available Rewards</h3>
                    <p style="margin-bottom: 25px; color: var(--gray-dark);">
                        Redeem your Eco Points for exciting rewards from our local partners!
                    </p>
                    
                    <div class="rewards-grid" id="rewards-grid">
                        <!-- Reward Items will be populated by JavaScript -->
                    </div>
                </div>
                
                <!-- My Rewards Tab -->
                <div class="tab-content" id="my-rewards-tab">
                    <h3 style="margin-bottom: 20px; color: var(--primary-green);">My Active Rewards</h3>
                    <p style="margin-bottom: 25px; color: var(--gray-dark);">
                        Your redeemed rewards ready to use. Show the QR code to our partners.
                    </p>
                    
                    <div id="active-rewards-container">
                        <div id="no-active-rewards" style="text-align: center; padding: 40px; color: var(--gray-dark); display: none;">
                            <div style="font-size: 48px; margin-bottom: 20px;">üéÅ</div>
                            <h3>No Active Rewards</h3>
                            <p>You haven't redeemed any rewards yet.</p>
                            <button class="btn btn-primary" onclick="switchRewardTab('marketplace')" style="margin-top: 20px;">
                                Browse Marketplace
                            </button>
                        </div>
                        <div class="active-rewards-grid" id="active-rewards-grid">
                            <!-- Active rewards will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Reward Redemption Modal -->
    <div id="reward-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-reward-title" class="modal-title"></h2>
            <p id="modal-reward-description" style="color: var(--gray-dark); margin-bottom: 25px;"></p>
            
            <div style="background: var(--lighter-green); padding: 20px; border-radius: var(--radius); margin-bottom: 25px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 14px; color: var(--gray-dark);">Your Points Balance</div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--primary-green);" id="modal-current-points">0</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 14px; color: var(--gray-dark);">Required Points</div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--secondary-orange);" id="modal-required-points">0</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 14px; color: var(--gray-dark);">Remaining After</div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--dark-green);" id="modal-remaining-points">0</div>
                    </div>
                </div>
            </div>
            
            <div id="modal-error" class="alert alert-error" style="display: none; margin-bottom: 20px;"></div>
            
            <div style="display: flex; gap: 15px; margin-top: 25px;">
                <button id="confirm-redeem-btn" class="btn btn-primary" style="flex: 1;">
                    ‚úÖ Confirm Redeem
                </button>
                <button onclick="closeRewardModal()" class="btn" style="flex: 1;">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Reward Success Modal -->
    <div id="reward-success-modal" class="modal-overlay">
        <div class="modal-content" style="text-align: center;">
            <div style="font-size: 60px; margin-bottom: 20px;">üéâ</div>
            <h2 style="color: var(--primary-green); margin-bottom: 15px;">Reward Redeemed Successfully!</h2>
            
            <div id="voucher-content" style="margin: 25px 0;">
                <!-- QR Code and Voucher Details will be populated here -->
            </div>
            
            <div style="background: var(--lighter-green); padding: 20px; border-radius: var(--radius); margin-bottom: 25px;">
                <div style="font-size: 14px; color: var(--gray-dark); margin-bottom: 5px;">Your new points balance</div>
                <div style="font-size: 32px; font-weight: 700; color: var(--primary-green);" id="success-new-points">0</div>
            </div>
            
            <p style="color: var(--gray-dark); margin-bottom: 25px;">
                Show this QR code to our partner to claim your reward. The code is valid for 30 days.
            </p>
            
            <div style="display: flex; gap: 15px; margin-top: 25px;">
                <button onclick="downloadQRCode()" class="btn btn-primary" style="flex: 1;">
                    Download QR Code
                </button>
                <button onclick="closeSuccessModalAndView()" class="btn" style="flex: 1;">
                    View in My Rewards
                </button>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="logo" style="font-size: 20px;">
                    <span>‚ôªÔ∏è</span>
                    <span>RecycleHub</span>
                </div>
                <div style="text-align: right;">
                    <p>Community Recycling Collection System</p>
                    <p>Helping communities recycle better</p>
                </div>
            </div>
            <div class="copyright">
                &copy; 2023 RecycleHub. All rights reserved.
            </div>
        </div>
    </footer>

    <script src="app-state.js"></script>
    <script src="rewards.js"></script>
    <script>
            document.addEventListener('DOMContentLoaded', function() {
         // Check if user is logged in
         const savedUser = localStorage.getItem('recycleHubUser');
         if (!savedUser || JSON.parse(savedUser).role !== 'user') {
             window.location.href = 'login.html';
             return;
         }

         // Initialize app state
         appState.currentUser = JSON.parse(savedUser);
         appState.isLoggedIn = true;
         appState.userRole = 'user';

         // Update navigation and user display
         updateNavigation();
         updateUserDisplay();

         // Load rewards page
         loadRewardsPage();

         // Setup event listeners
         document.getElementById('confirm-redeem-btn').addEventListener('click', confirmRedeem);
     });

     function loadRewardsPage() {
         const userPickups = appState.sampleData.pickups.filter(
             p => p.userId === appState.currentUser.id && p.status === 'completed'
         );
         const totalPoints = userPickups.reduce((sum, p) => sum + (p.finalWeight || 0) * 10, 0);

         // Update points display
         document.getElementById('current-points-balance').textContent = totalPoints;
         document.getElementById('modal-current-points').textContent = totalPoints;
         document.getElementById('success-new-points').textContent = totalPoints;

         // Determine user rank
         const userRank = getUserRank(totalPoints);
         document.getElementById('user-rank').textContent = userRank.name;
         document.getElementById('user-rank').style.color = userRank.color;

         // Update progress bar
         updateRankProgress(totalPoints);

         // Load marketplace rewards
         loadMarketplaceRewards(totalPoints);

         // Load user's active rewards
         loadActiveRewards();
     }

     function getUserRank(points) {
         const ranks = appState.rewardsData.ranks;
         let currentRank = ranks[0];

         for (let i = ranks.length - 1; i >= 0; i--) {
             if (points >= ranks[i].minPoints) {
                 currentRank = ranks[i];
                 break;
             }
         }

         // Calculate next rank
         const currentIndex = ranks.findIndex(r => r.name === currentRank.name);
         if (currentIndex < ranks.length - 1) {
             const nextRank = ranks[currentIndex + 1];
             const pointsNeeded = nextRank.minPoints - points;
             document.getElementById('next-rank-points').textContent = pointsNeeded > 0 ? pointsNeeded : 0;
         } else {
             document.getElementById('next-rank-points').textContent = "Max rank achieved!";
         }

         return currentRank;
     }

     function updateRankProgress(points) {
         const ranks = appState.rewardsData.ranks;
         const maxRankPoints = ranks[ranks.length - 1].minPoints;

         let progress = 0;
         if (points >= maxRankPoints) {
             progress = 100;
         } else {
             // Find current and next rank
             for (let i = 0; i < ranks.length - 1; i++) {
                 if (points >= ranks[i].minPoints && points < ranks[i + 1].minPoints) {
                     const range = ranks[i + 1].minPoints - ranks[i].minPoints;
                     const progressInRange = points - ranks[i].minPoints;
                     progress = (i / (ranks.length - 1)) * 100 + (progressInRange / range) * (100 / (ranks.length - 1));
                     break;
                 }
             }
         }

         document.getElementById('rank-progress').style.width = progress + '%';
     }

     function getRewardEmoji(category) {
         const emojis = {
             food: "‚òï",
             transport: "üöå",
             shopping: "üõçÔ∏è",
             entertainment: "üé¨",
             garden: "üå±",
             merchandise: "üéÅ"
         };
         return emojis[category] || "üéÅ";
     }

     function loadMarketplaceRewards(userPoints) {
         const rewardsGrid = document.getElementById('rewards-grid');
         rewardsGrid.innerHTML = '';

         appState.rewardsData.rewards.forEach(reward => {
             const canAfford = userPoints >= reward.points;
             const rewardCard = document.createElement('div');
             rewardCard.className = canAfford ? 'reward-card' : 'reward-card disabled';

             rewardCard.innerHTML = `
                 <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                     <div style="font-size: 24px;">
                         ${getRewardEmoji(reward.category)}
                     </div>
                     <div style="text-align: right;">
                         <div style="font-size: 12px; color: var(--gray-dark);">Cost</div>
                         <div style="font-size: 20px; font-weight: 700; color: ${canAfford ? 'var(--secondary-orange)' : 'var(--gray-dark)'}">
                             ${reward.points} pts
                         </div>
                     </div>
                 </div>

                 <h4 style="margin-bottom: 10px; color: var(--primary-green);">${reward.name}</h4>
                 <p style="color: var(--gray-dark); font-size: 14px; margin-bottom: 15px;">${reward.description}</p>

                 <div style="display: flex; justify-content: space-between; align-items: center;">
                     <span style="font-size: 12px; color: var(--gray-dark);">${reward.partner}</span>
                     <div style="font-size: 20px;">
                         ${canAfford ? '‚úÖ' : 'üîí'}
                     </div>
                 </div>
             `;

             if (canAfford) {
                 rewardCard.style.cursor = 'pointer';
                 rewardCard.addEventListener('click', () => openRewardModal(reward));
                 rewardCard.addEventListener('mouseover', () => rewardCard.style.boxShadow = 'var(--shadow)');
                 rewardCard.addEventListener('mouseout', () => rewardCard.style.boxShadow = 'none');
             }

             rewardsGrid.appendChild(rewardCard);
         });
     }

     function loadActiveRewards() {
         const container = document.getElementById('active-rewards-container');
         const noRewardsMsg = document.getElementById('no-active-rewards');
         const rewardsGrid = document.getElementById('active-rewards-grid');

         if (appState.rewardsData.userRewards.length === 0) {
             rewardsGrid.innerHTML = '';
             noRewardsMsg.style.display = 'block';
         } else {
             noRewardsMsg.style.display = 'none';
             rewardsGrid.innerHTML = '';

             appState.rewardsData.userRewards.forEach(reward => {
                 const rewardCard = document.createElement('div');
                 rewardCard.style.cssText = `
                     background: white;
                     border: 2px solid var(--light-green);
                     border-radius: var(--radius);
                     padding: 20px;
                     box-shadow: var(--shadow);
                 `;

                 rewardCard.innerHTML = `
                     <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                         <div style="font-size: 32px;">
                             ${getRewardEmoji(reward.category)}
                         </div>
                         <span class="status-badge status-completed" style="font-size: 12px;">Active</span>
                     </div>

                     <h4 style="margin-bottom: 10px; color: var(--primary-green);">${reward.name}</h4>
                     <p style="color: var(--gray-dark); font-size: 14px; margin-bottom: 15px;">${reward.description}</p>

                     <div style="text-align: center; margin: 20px 0; padding: 15px; background: var(--lighter-green); border-radius: var(--radius);">
                         <div style="font-size: 14px; color: var(--gray-dark); margin-bottom: 10px;">Your Voucher Code</div>
                         <div style="font-family: monospace; font-size: 18px; font-weight: 700; letter-spacing: 2px; color: var(--primary-green);">
                             ${reward.voucherCode}
                         </div>
                         <div style="margin: 15px auto; width: 150px; height: 150px; background: #f5f5f5; display: flex; align-items: center; justify-content: center; border-radius: var(--radius);">
                             <div style="font-size: 48px;">üì±</div>
                         </div>
                         <div style="font-size: 12px; color: var(--gray-dark);">
                             Valid until: ${formatDate(new Date(reward.validUntil))}
                         </div>
                     </div>

                     <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                         <span style="font-size: 12px; color: var(--gray-dark);">${reward.partner}</span>
                         <button class="btn" onclick="downloadQRCode()" style="padding: 5px 15px; font-size: 14px;">
                             Download QR
                         </button>
                     </div>
                 `;

                 rewardsGrid.appendChild(rewardCard);
             });
         }
     }

     function switchRewardTab(tabName) {
         // Update tabs
         document.querySelectorAll('.tab').forEach(tab => {
             tab.classList.remove('active');
         });

         // Update tab content
         document.querySelectorAll('.tab-content').forEach(content => {
             content.classList.remove('active');
         });

         // Activate clicked tab
         const activeTab = document.querySelector(`.tab[onclick="switchRewardTab('${tabName}')"]`);
         if (activeTab) activeTab.classList.add('active');
         document.getElementById(`${tabName}-tab`).classList.add('active');
     }

     function openRewardModal(reward) {
         const userPickups = appState.sampleData.pickups.filter(
             p => p.userId === appState.currentUser.id && p.status === 'completed'
         );
         const userPoints = userPickups.reduce((sum, p) => sum + (p.finalWeight || 0) * 10, 0);

         appState.currentRewardRedemption = reward;

         document.getElementById('modal-reward-title').textContent = reward.name;
         document.getElementById('modal-reward-description').textContent = reward.description;
         document.getElementById('modal-current-points').textContent = userPoints;
         document.getElementById('modal-required-points').textContent = reward.points;
         document.getElementById('modal-remaining-points').textContent = userPoints - reward.points;

         // Clear any previous error
         document.getElementById('modal-error').style.display = 'none';

         // Show modal
         document.getElementById('reward-modal').style.display = 'flex';
     }

     function closeRewardModal() {
         document.getElementById('reward-modal').style.display = 'none';
         appState.currentRewardRedemption = null;
     }

     function confirmRedeem() {
         if (!appState.currentRewardRedemption || !appState.currentUser) return;

         const reward = appState.currentRewardRedemption;

         // Step 1: Validation Check
         const userPickups = appState.sampleData.pickups.filter(
             p => p.userId === appState.currentUser.id && p.status === 'completed'
         );
         const userPoints = userPickups.reduce((sum, p) => sum + (p.finalWeight || 0) * 10, 0);

         if (userPoints < reward.points) {
             document.getElementById('modal-error').textContent = `Insufficient points! You need ${reward.points - userPoints} more points.`;
             document.getElementById('modal-error').style.display = 'block';
             return;
         }

         // Step 3: Database Update (simulated)
         const voucherCode = 'RH' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substr(2, 4).toUpperCase();
         const validUntil = new Date();
         validUntil.setDate(validUntil.getDate() + 30);

         const userReward = {
             id: appState.rewardsData.userRewards.length + 1,
             rewardId: reward.id,
             userId: appState.currentUser.id,
             name: reward.name,
             description: reward.description,
             pointsCost: reward.points,
             category: reward.category,
             partner: reward.partner,
             voucherCode: voucherCode,
             validUntil: validUntil.toISOString(),
             redeemedAt: new Date().toISOString(),
             status: 'active'
         };

         // Add to user rewards
         appState.rewardsData.userRewards.push(userReward);

         // Step 4: Show Success Screen
         showSuccessScreen(userReward, userPoints - reward.points);
     }

     function showSuccessScreen(userReward, newPointsBalance) {
         closeRewardModal();

         document.getElementById('success-new-points').textContent = newPointsBalance;

         const voucherContent = document.getElementById('voucher-content');
         voucherContent.innerHTML = `
             <div style="background: linear-gradient(135deg, var(--light-green), var(--primary-green)); color: white; padding: 25px; border-radius: var(--radius); margin-bottom: 20px;">
                 <div style="font-size: 20px; font-weight: 700; margin-bottom: 10px;">${userReward.name}</div>
                 <div style="font-size: 14px; opacity: 0.9;">${userReward.description}</div>
             </div>

             <div style="display: flex; align-items: center; gap: 20px; margin: 25px 0; flex-wrap: wrap;">
                 <div style="flex: 1; min-width: 200px;">
                     <div style="font-size: 14px; color: var(--gray-dark); margin-bottom: 5px;">Voucher Code</div>
                     <div style="font-family: monospace; font-size: 24px; font-weight: 700; color: var(--primary-green); letter-spacing: 3px;">
                         ${userReward.voucherCode}
                     </div>
                 </div>
                 <div style="flex: 1; min-width: 150px; text-align: center;">
                     <div style="font-size: 60px;">üì±</div>
                     <div style="font-size: 12px; color: var(--gray-dark);">Show QR to partner</div>
                 </div>
             </div>

             <div style="background: var(--lighter-green); padding: 15px; border-radius: var(--radius); margin-top: 20px;">
                 <div style="display: flex; justify-content: space-between; font-size: 14px;">
                     <span>Partner:</span>
                     <span style="font-weight: 600;">${userReward.partner}</span>
                 </div>
                 <div style="display: flex; justify-content: space-between; font-size: 14px; margin-top: 5px;">
                     <span>Valid until:</span>
                     <span style="font-weight: 600;">${formatDate(userReward.validUntil)}</span>
                 </div>
             </div>
         `;

         document.getElementById('reward-success-modal').style.display = 'flex';
     }

     function closeSuccessModal() {
         document.getElementById('reward-success-modal').style.display = 'none';
         loadRewardsPage(); // Refresh the page
     }

     function closeSuccessModalAndView() {
         document.getElementById('reward-success-modal').style.display = 'none';
         switchRewardTab('my-rewards');
         loadActiveRewards();
     }

     function downloadQRCode() {
         alert('QR Code would be downloaded in a real application.');
     }
    </script>
</body>
</html>